<head>
  <style>
    body { 
      background-color: white; 
      font-family: "arial"; 
      text-align: center;
      border-radius: 5;
      color: black;
    }

    .content {
      padding: 18px;
      display: none;
      overflow: hidden;
      background-color: white;
    }

    #threads {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }

    .toggle {
        display: flex;
        align-items: center;
        padding: 10px;
        margin-bottom: 10px;
        border: 1px solid lightgray;
        border-radius: 4px;
        background-color: white;
        position: relative;
        width: 600px;
        flex-wrap: nowrap;
        overflow: hidden;
    }
    .toggle-title {
        font-size: 16px;
        padding-right: 20px;
        width: fit-content;
        background: none;
        border: none;
    }
    .toggle::before {
        content: "";
        position: absolute;
        top: 50%;
        right: 10px;
        transform: translateY(-50%);
        border-left: 5px solid transparent;
        border-right: 5px solid transparent;
        border-top: 7px solid gray;
    }
    .toggle.show::before {
        transform: translateY(-50%) rotate(180deg);
        border-top: none;
        border-bottom: 7px solid gray;
    }
    .toggle ul {
        display: none;
        list-style-type: none;
        margin: 0;
        padding: 0;
    }
    .toggle.show ul {
        display: block;
    }
    .toggle ul li {
        padding: 10px;
    }
    .toggle.unread {
        background-color: #f9f9f9;
        color: #333333;
    }
    .toggle.unread .toggle-title {
        color: #333333;
    }
    .toggle.unread .toggle-title {
        font-weight: bold; /* make the text bold */
        color: #333333; /* change the text color */
    }
        
  </style>
  <title>Pony</title>
</head>

<body>
  <main>
    <h1>Pony</h1>
    <br>
    <button type="button" class="collapsible">New Thread</button>
    <div class="content">
        <label for="Title">Title</label>
        <br>
        <input type="text" id="titleBox" size="50"><br><br>
        <label for="Message">Message</label>
        <br>
        <textarea id="messageBox" rows="10" cols="50"></textarea><br><br>
        <label for="PublicParticipants">Public Participants</label>
        <br>
        <input type="text" id="participantBox" size="50" placeholder="~sampel-palnet ~hanfel-dovned"><br><br>
        <label for="SecretParticipants">Secret Participants</label>
        <br>
        <input type="text" id="voyeurBox" size="50" placeholder="~sampel-palnet ~hanfel-dovned"><br><br>
        <button onclick="postNewThread()">Create Thread</button>
        <button onclick="postSaveDraft()">Save Draft</button>
        <br><br>
        <div id="drafts"></div>
    </div>
    <br>
    <h3>Threads</h3>
    <input type="text" id="searchBox" placeholder = "tag or ~sampel-palnet">
    <button type="button" onclick="search()">Search</button>
    <br><br>
    <div id="threads"></div>
    <script>
    

function post(tag, data) {
    fetch('/apps/pony', {
        method: 'POST',
        body: JSON.stringify({[tag]: data})
    })
    location.reload()
}

getState()
    .then((state) => renderPage(state))

async function getState() {
    const response = await fetch('/apps/pony/state')
    return response.json()
}

var idi = 0;
var titlei = 1;
var hosti = 2;
var messagesi = 3;
var participantsi = 4;
var voyeursi = 5;
var folderi = 6;
var tagsi = 7;
var readi = 8;

function search() 
{
    var searchTerm = document.getElementById("searchBox").value;
    window.location.href = "pony/search/" + searchTerm;
}


function postNewThread()
{
    //This will handle both the case where the user correctly
    //formats the (list @p) and the case where the user correctly leaves the box
    //blank. TODO: The frontend should also disallow clicking the Create Thread button
    //unless these lists are formatted correctly in the first place.

    var participants = document.getElementById('participantBox').value.split(" ")
    if(participants[0] == [''])
      participants = []

    var voyeurs = document.getElementById('voyeurBox').value.split(" ")
    if(voyeurs[0] == [''])
      voyeurs = []

    post("new-thread", [document.getElementById('titleBox').value, 
                        document.getElementById('messageBox').value,
                        participants,
                        voyeurs,]);
}

function postSaveDraft()
{
    var participants = document.getElementById('participantBox').value.split(" ")
    if(participants[0] == [''])
      participants = []

    var voyeurs = document.getElementById('voyeurBox').value.split(" ")
    if(voyeurs[0] == [''])
      voyeurs = []

    post("new-draft", [document.getElementById('titleBox').value, 
                        document.getElementById('messageBox').value,
                        participants,
                        voyeurs,]);
}

function postDeleteDraft(draft)
{
    post("delete-draft", [draft[0], draft[1], draft[2], draft[3]]);
}


//Logic for collapsible new thread form
var coll = document.getElementsByClassName("collapsible");
var i;

for (i = 0; i < coll.length; i++) {
  coll[i].addEventListener("click", function() {
    this.classList.toggle("active");
    var content = this.nextElementSibling;
    if (content.style.display === "block") {
      content.style.display = "none";
    } else {
      content.style.display = "block";
    }
  });
}

function renderPage(state)
{
    const sortedState = state[0].reduce((acc, cur) => {
        const folder = cur[folderi];
        if (!acc[folder]) {
            acc[folder] = [];
        }
        acc[folder].push(cur);
        return acc;
    }, {});

    for (const folder in sortedState) {
        sortedState[folder].sort((a, b) => a[readi] - b[readi]);
    }

    //Threads
    const toggleContainer = document.getElementById("threads");

    for (const folder in sortedState) {
        // create a container for each folder
        const toggle = document.createElement("div");
        toggle.classList.add('toggle');
        
        // create a toggle button
        const button = document.createElement("button");
        button.textContent = folder;
        button.classList.add('toggle-title')
        toggle.appendChild(button);

        // check if folder contains any unread threads
        let hasOne = false;
        sortedState[folder].forEach(thread => {
            if(!thread[readi]){
                hasOne = true;
            }
        });
        if(hasOne){
            toggle.classList.add("unread");
        }
        
        // add event listener for toggle
        toggle.addEventListener("click", function(){
            toggle.classList.toggle("show");
        });
        
        // create container for the threads in the folder
        const threadList = document.createElement("ul");
        // create an item for each thread in the folder
        sortedState[folder].forEach(thread => {
            const threadItem = document.createElement("li");
            const link = document.createElement("a");
            link.textContent = thread[titlei];
            link.href = "/apps/pony/" + thread[idi] + "/t";
            if(!thread[readi])
              link.style.fontWeight = 'bold';
            threadItem.appendChild(link);
            threadList.appendChild(threadItem);
        });
        
        toggle.appendChild(threadList);
        toggleContainer.appendChild(toggle);
    }


    /*for(var i = 0; i < state[0].length; i++)
    {
        const thread = document.createElement("a");
        thread.textContent = state[0][i][titlei];
        thread.setAttribute('href', "pony/" + state[0][i][idi] + "/t");
        threads.appendChild(thread);

        threads.appendChild(document.createElement("br"));
        threads.appendChild(document.createElement("br"));
    }*/


    //Drafts
    const drafts = document.getElementById("drafts");

    if(state[1].length > 0)
    {
      const headerDr = document.createElement("h3");
      headerDr.textContent = "Drafts";
      drafts.appendChild(headerDr);
    }

    for(var i = 0; i < state[1].length; i++) {
        const draft = document.createElement("a");
        draft.textContent = state[1][i][0];
        draft.setAttribute('href', "javascript:void(0)");
        drafts.appendChild(draft);

        // create a delete button
        const deleteBtn = document.createElement("button");
        deleteBtn.textContent = "X";
        deleteBtn.setAttribute("onClick", `postDeleteDraft(${JSON.stringify(state[1][i])})`);
        drafts.appendChild(document.createTextNode(" ")); // add a space
        drafts.appendChild(deleteBtn);

        drafts.appendChild(document.createElement("br"));
        drafts.appendChild(document.createElement("br"));

        //need to do it this way becase "i" won't be the same when you click the link
        //as it is when this function was defined
        draft.addEventListener("click", (function(index){
              return function(){
                  document.getElementById("titleBox").value = state[1][index][0];
                  document.getElementById("messageBox").innerHTML = state[1][index][1];
                  document.getElementById("participantBox").value = state[1][index][2];
                  document.getElementById("voyeurBox").value = state[1][index][3];
              }
          })(i));
        }
}


</script>
</main>

