<head>
  <style>
    body { 
      background-color: white; 
      font-family: "arial"; 
      text-align: center;
      border-radius: 5;
      color: black;
    }

    .content {
      padding: 18px;
      display: none;
      overflow: hidden;
      background-color: white;
    }
  </style>
  <title>Pony</title>
</head>

<body>
  <main>
    <h1>Pony</h1>
    <div id="drafts"></div>
    <br>
    <button type="button" class="collapsible">New Thread</button>
    <div class="content">
        <label for="Title">Title</label>
        <br>
        <input type="text" id="titleBox" size="50"><br><br>
        <label for="Message">Message</label>
        <br>
        <textarea id="messageBox" rows="10" cols="50"></textarea><br><br>
        <label for="PublicParticipants">Public Participants</label>
        <br>
        <input type="text" id="participantBox" size="50" placeholder="~sampel-palnet ~hanfel-dovned"><br><br>
        <label for="SecretParticipants">Secret Participants</label>
        <br>
        <input type="text" id="voyeurBox" size="50" placeholder="~sampel-palnet ~hanfel-dovned"><br><br>
        <button onclick="postNewThread()">Create Thread</button>
    </div>
    <br>
    <h3>Threads</h3>
    <div id="threads"></div>
    <script>
    

function post(tag, data) {
    fetch('/apps/pony', {
        method: 'POST',
        body: JSON.stringify({[tag]: data})
    })
    location.reload()
}

getState()
    .then((state) => renderPage(state))

async function getState() {
    const response = await fetch('/apps/pony/state')
    return response.json()
}


function postNewThread()
{
    //If participants or voyeurs is blank, you should still be able to post
    //the thread. This will handle both the case where the user correctly
    //formats the (list @p) and the case where the user correctly leaves the box
    //blank. TODO: The frontend should also disallow clicking the Create Thread button
    //unless these lists are formatted correctly in the first place.

    var participants = document.getElementById('participantBox').value.split(" ")
    if(participants[0] == [''])
      participants = []

    var voyeurs = document.getElementById('voyeurBox').value.split(" ")
    if(voyeurs[0] == [''])
      voyeurs = []

    post("new-thread", [document.getElementById('titleBox').value, 
                        document.getElementById('messageBox').value,
                        participants,
                        voyeurs,]);
}

//Logic for collapsible new thread form
var coll = document.getElementsByClassName("collapsible");
var i;

for (i = 0; i < coll.length; i++) {
  coll[i].addEventListener("click", function() {
    this.classList.toggle("active");
    var content = this.nextElementSibling;
    if (content.style.display === "block") {
      content.style.display = "none";
    } else {
      content.style.display = "block";
    }
  });
}

function renderPage(state)
{

    //Drafts
    /*const drafts = document.getElementById("drafts");

    if(state[1].length > 0)
    {
      const headerDr = document.createElement("h3");
      headerDr.textContent = "Drafts";
      drafts.appendChild(headerDr);
    }

    for(var i = 0; i < state[1].length; i++)
    {
        const draft = document.createElement("a");
        draft.textContent = state[1][i][0];
        draft.setAttribute('href', "pony/drafts/" + state[1][i][0]);
        drafts.appendChild(draft);

        drafts.appendChild(document.createElement("br"));
        drafts.appendChild(document.createElement("br"));
    }*/

    //Threads
    const threads = document.getElementById("threads");

    for(var i = 0; i < state[0].length; i++)
    {
        const thread = document.createElement("a");
        thread.textContent = state[0][i][1];
        thread.setAttribute('href', "pony/" + state[0][i][0] + "/t");
        threads.appendChild(thread);

        threads.appendChild(document.createElement("br"));
        threads.appendChild(document.createElement("br"));
    }
}

</script>
</main>