<head>
  <style>
    body { 
      background-color: white; 
      font-family: "arial"; 
      text-align: center;
      border-radius: 5;
      color: black;
    }

    .content {
      padding: 18px;
      display: none;
      overflow: hidden;
      background-color: white;
    }

    #new-folder-container {
      display: inline-block;
      margin-left: 10px;
    }
    #folder-select {
      display: inline-block;
      margin-left: 10px;
    }
    #select-folder-button {
      display: inline-block;
      margin-left: 10px;
    }

  </style>
  <title>Pony</title>
</head>

<body>
  <main>
    <div id="messages"></div>
    <textarea id="messageBox" rows="10" cols="50"></textarea><br><br>
    <button onclick="postNewMessage()">Post</button><br><br><br>
    <input type="text" id="addShipBox" placeholder="~sampel-palnet">
    <button onclick="postAddShip()">Invite Ship to Thread</button><br><br><br>
    <div>
      <select id="folder-select">
        <option id="new-folder-option" value="new">New Folder</option>
      </select>
      <div id="new-folder-container" style="display: none;">
        <input type="text" id="new-folder-input" placeholder="New Folder Name">
      </div>
      <button id="select-folder-button" onclick="postMoveToFolder()">Move to Folder</button>
    </div><br><br>
    <button type="button" class="collapsible">Fork Thread</button>
    <div class="content">
        <label for="PublicParticipants">Public Participants</label>
        <br>
        <input type="text" id="participantBox" size="50" placeholder="~sampel-palnet ~hanfel-dovned"><br><br>
        <label for="SecretParticipants">Secret Participants</label>
        <br>
        <input type="text" id="voyeurBox" size="50" placeholder="~sampel-palnet ~hanfel-dovned"><br><br>
        <button onclick="postForkThread()">Fork</button>
    </div>
    <script>
    

function post(tag, data) {
    fetch('/apps/pony', {
        method: 'POST',
        body: JSON.stringify({[tag]: data})
    })
    location.reload()
}

getState()
    .then((state) => renderPage(state))

var idi = 0;
var titlei = 1;
var hosti = 2;
var messagesi = 3;
var participantsi = 4;
var voyeursi = 5;
var folderi = 6;
var tagsi = 7;
var readi = 8;


async function getState() {
    const response = await fetch('/apps/pony/state')
    return response.json()
}

var threadID = window.location.href.split("/")
threadID = threadID[threadID.length - 2]

//Logic for collapsible new thread form
var coll = document.getElementsByClassName("collapsible");
var i;

for (i = 0; i < coll.length; i++) {
  coll[i].addEventListener("click", function() {
    this.classList.toggle("active");
    var content = this.nextElementSibling;
    if (content.style.display === "block") {
      content.style.display = "none";
    } else {
      content.style.display = "block";
    }
  });
}

function postAddShip()
{
    post("add-ship", [threadID, document.getElementById('addShipBox').value]);
}

function postNewMessage()
{
    post("new-message", [threadID, document.getElementById('messageBox').value]);
}

function postNewDraft()
{
    post("new-draft", [threadID, document.getElementById('messageBox').value]);
}

function postForkThread()
{
    post("fork-thread", [threadID, document.getElementById('participantBox').value.split(" "),
                                    document.getElementById('voyeurBox').value.split(" "),]);
}

function postAddTags()
{
    post("add-tags", [threadID, document.getElementById('addTagsBox').value.split(" ")]);
}

function postRemoveTag(tag)
{
    post("remove-tag", [threadID, tag]);
}

function postMoveToFolder()
{
    let selectedFolder = document.getElementById('folder-select').value;
    if (selectedFolder === 'new') {
        selectedFolder = document.getElementById('new-folder-input').value;
    }

    post("move-to-folder", [threadID, selectedFolder]);
}

function renderPage(state)
{
    //Add messages to page.
    const messages = document.getElementById("messages");

    const threadIndex = state[0].findIndex(x => x[0] == threadID)

    const title = document.createElement("h2");
    title.textContent = state[0][threadIndex][titlei];
    messages.appendChild(title);

    //Participants
    const partHeader = document.createElement("a");
    partHeader.textContent = "Participants: ";
    messages.appendChild(partHeader);

    for(var i = 0; i < state[0][threadIndex][participantsi].length; i++)
    {
        const participant = document.createElement("a");
        participant.textContent = state[0][threadIndex][4][i] + " ";
        messages.appendChild(participant);
    }

    messages.appendChild(document.createElement("br"));
    messages.appendChild(document.createElement("br"));
    messages.appendChild(document.createElement("br"));

    //Tags
    const addTagsTextbox = document.createElement("input");
    addTagsTextbox.setAttribute("type", "text");
    addTagsTextbox.setAttribute("placeholder", "tag-one tag-two");
    addTagsTextbox.setAttribute("id", "addTagsBox");

    const addTagsButton = document.createElement("button");
    addTagsButton.textContent = "Add Tags";
    addTagsButton.addEventListener("click", postAddTags);

    messages.appendChild(addTagsTextbox);
    messages.appendChild(addTagsButton);
    messages.appendChild(document.createElement("br"));
    messages.appendChild(document.createElement("br"));

    for(var i = 0; i < state[0][threadIndex][tagsi].length; i++)
    {
        const tag = document.createElement("a");
        tag.textContent = state[0][threadIndex][tagsi][i] + " ";
        messages.appendChild(tag);

        // delete button
        const deleteBtn = document.createElement("button");
        deleteBtn.textContent = "X";
        deleteBtn.setAttribute("onClick", `postRemoveTag(${JSON.stringify(state[0][threadIndex][tagsi][i])})`);
        messages.appendChild(document.createTextNode(" "));
        messages.appendChild(deleteBtn);
        messages.appendChild(document.createTextNode(" "));
    }


    messages.appendChild(document.createElement("br"));
    messages.appendChild(document.createElement("br"));
    messages.appendChild(document.createElement("br"));
    

    //Messages
    for(var i = 0; i < state[0][threadIndex][3].length; i++)
    {
        
        const message = document.createElement("a");
        message.textContent = state[0][threadIndex][3][i][1];
        messages.appendChild(message);
        messages.appendChild(document.createElement("br"));
        messages.appendChild(document.createElement("br"));

        const author = document.createElement("a");
        author.textContent = state[0][threadIndex][3][i][2] + " - ";
        messages.appendChild(author);

        const date = document.createElement("a");
        date.textContent = state[0][threadIndex][3][i][0];
        messages.appendChild(date);

        messages.appendChild(document.createElement("br"));
        messages.appendChild(document.createElement("br"));
        messages.appendChild(document.createElement("br"));
    }

    const select = document.getElementById("folder-select");
    const newFolderOption = document.getElementById("new-folder-option");
    const newFolderContainer = document.getElementById("new-folder-container");
    const newFolderInput = document.getElementById("new-folder-input");
    const button = document.getElementById("select-folder-button");

    // Extract the unique folders
    let folders = state[0].map(f => f[folderi]).filter((folder, i, self) => self.indexOf(folder) === i);

    // Populate the dropdown with options for each folder in state
    folders.forEach((folder) => {
      const option = document.createElement("option");
      option.value = folder;
      option.text = folder;
      select.appendChild(option);
    });

    select.selectedIndex = 1; //skip the "New Folder" option at first

    // Add an event listener to the select that shows/hides the text box when the "New Folder" option is selected
    select.addEventListener("change", function(){
        if(select.value === "new") {
            newFolderContainer.style.display = "block";
        }else{
            newFolderContainer.style.display = "none";
        }
    });
}

</script>
</main>