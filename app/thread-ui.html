<head>
  <style>
    body { 
      background-color: white; 
      font-family: "arial"; 
      text-align: center;
      border-radius: 5;
      color: black;
    }
  </style>
  <title>Pony</title>
</head>

<body>
  <main>
    <div id="threads"></div>
    <script>
    

function post(tag, data) {
    fetch('/apps/pony', {
        method: 'POST',
        body: JSON.stringify({[tag]: data})
    })
    location.reload()
}

getState()
    .then((state) => renderPage(state))

async function getState() {
    const response = await fetch('/apps/pony/state')
    return response.json()
}

var threadID = window.location.href.split("/")
threadID = threadID[threadID.length - 1]

function postAddShip()
{
    post("add-ship", [threadID, document.getElementById('addShipBox').value]);
}

function postNewMessage()
{
    post("new-message", [threadID, document.getElementById('messageBox').value]);
}

function postNewDraft()
{
    post("new-draft", [threadID, document.getElementById('messageBox').value]);
}

/*function postDeletePage()
{
    var page = event.currentTarget.myPage;
    post("delete-page", page);
}*/

function renderPage(state)
{
    //Add messages to page.
    const messages = document.getElementById("threads");

    const threadIndex = state[0].findIndex(x => x[0] == threadID)

    for(var i = 0; i < state[0][threadIndex][3].length; i++)
    {
        const message = document.createElement("a");
        message.textContent = state[0][threadIndex][3][i];
        messages.appendChild(message);

        messages.appendChild(document.createElement("br"));
        messages.appendChild(document.createElement("br"));
    }

    //Add "Add Ship" button to page.
    const addShipBox = document.createElement('input'); 
    addShipBox.type = "text"; 
    addShipBox.id = "addShipBox";
    messages.appendChild(addShipBox);

    const addShipButton = document.createElement("button");
    addShipButton.textContent = "Add Ship to Thread";
    addShipButton.addEventListener('click', postAddShip);
    messages.appendChild(addShipButton);

    threads.appendChild(document.createElement("br"));
    threads.appendChild(document.createElement("br"));

    //Add posting textbox and buttons to page.
    const messageBox = document.createElement('input'); 
    messageBox.type = "text"; 
    messageBox.id = "messageBox";
    messages.appendChild(messageBox);

    threads.appendChild(document.createElement("br"));

    const messageButton = document.createElement("button");
    messageButton.textContent = "Post";
    messageButton.addEventListener('click', postNewMessage);
    messages.appendChild(messageButton);

    const draftButton = document.createElement("button");
    draftButton.textContent = "Save Draft";
    draftButton.addEventListener('click', postNewDraft);
    messages.appendChild(draftButton);

    threads.appendChild(document.createElement("br"));
    threads.appendChild(document.createElement("br"));
}

</script>
</main>